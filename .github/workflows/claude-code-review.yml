name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            You are reviewing a pull request for Scenarist, a hexagonal architecture library for managing MSW mock scenarios.

            **Review Guidelines:**
            Read `.claude/review-prompt.md` for comprehensive review rules specific to this repository.
            Also reference `CLAUDE.md` for general development guidance.
            Review testing approach against `docs/testing-guidelines.md` and `docs/adrs/0003-testing-strategy.md`.

            **CRITICAL: Library vs Example Apps**
            - **Library Code (`packages/*`)**: Strict hexagonal architecture - enforce ALL rules below
            - **Example Apps (`apps/*`)**: Demonstration/testing applications showing real-world Scenarist usage
              - These are NOT library code - they're realistic example applications
              - They intentionally use non-hexagonal patterns (direct HTTP calls, framework coupling, imperative code)
              - DO NOT flag hexagonal violations in `apps/*` - they're meant to show practical integration
              - Focus reviews on: test quality, correct Scenarist usage, production parity demonstration
              - Example apps exist to prove Scenarist works in real frameworks with real patterns

            **Key Architecture Rules to Enforce (packages/* ONLY):**
            1. Hexagonal Architecture - Core has zero framework dependencies
            2. Serializable Scenarios - No functions in scenario definitions
            3. Dependency Injection - All ports injected, never created internally
            4. Explicit Implementation - Adapters must use `implements PortInterface`
            5. TDD - All production code must have tests (RED → GREEN → REFACTOR)
            6. Type System - Ports use `interface`, data uses `type` with `readonly`
            7. Four-Layer Testing - Core (100%), Adapter (translation), Integration (flows), Bruno (docs)
            8. Behavior Testing - Test through public APIs, not implementation details

            **Your Task:**
            1. Read the PR changes using `gh pr diff ${{ github.event.pull_request.number }}`
            2. Review against the rules in `.claude/review-prompt.md`
            3. For `packages/*` changes: Check for violations of hexagonal architecture, serialization, dependency injection
            4. For `apps/*` changes: Focus on test quality, correct Scenarist usage, realistic integration patterns
            5. Verify test coverage follows appropriate strategy (four-layer for library, E2E for examples)
            6. Ensure tests verify behavior, not implementation details
            7. Check that tests are at the correct layer (core vs adapter vs integration vs E2E)
            8. Leave a constructive review comment using `gh pr comment ${{ github.event.pull_request.number }} --body "..."`

            Be specific, reference relevant documentation, and provide examples. For library code (`packages/*`), focus on architecture violations first, then code quality. For example apps (`apps/*`), focus on demonstrating realistic usage patterns and test coverage.

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

