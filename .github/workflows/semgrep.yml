name: Semgrep

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Sundays
    - cron: "0 1 * * 0"

# Minimal permissions at workflow level
# @see https://github.com/citypaul/scenarist/security/code-scanning/103
permissions:
  contents: read

jobs:
  semgrep:
    name: Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Grant security-events permission only at job level where needed
    permissions:
      contents: read
      security-events: write

    container:
      image: semgrep/semgrep@sha256:2b10bb6c3502cad7775542283050b632c13bde1cfdfad7f8230859767a58a078

    steps:
      # Version PRs only modify package.json, CHANGELOG.md, and .changeset files
      # No code changes to scan - skip expensive analysis
      # Note: Scheduled runs always run the full scan
      - name: Check for Version PR
        id: check-version-pr
        env:
          EVENT_NAME: ${{ github.event_name }}
          HEAD_REF: ${{ github.head_ref }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          # For pull requests: check branch name
          if [ "$EVENT_NAME" = "pull_request" ]; then
            if [ "$HEAD_REF" = "changeset-release/main" ]; then
              echo "Version PR detected - skipping semgrep scan"
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # For push events: check commit message
          if [ "$EVENT_NAME" = "push" ]; then
            case "$COMMIT_MSG" in
              "chore: release packages"*)
                echo "Version PR merge detected - skipping semgrep scan"
                echo "skip=true" >> $GITHUB_OUTPUT
                exit 0
                ;;
            esac
          fi

          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Checkout
        if: steps.check-version-pr.outputs.skip != 'true'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Run Semgrep
        if: steps.check-version-pr.outputs.skip != 'true'
        # Report findings to GitHub Security tab without blocking builds
        # Findings should be triaged and addressed, not auto-blocked
        run: semgrep scan --config auto --sarif --output semgrep.sarif .

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@19b2f06db2b6f5108140aeb04014ef02b648f789 # v4
        if: steps.check-version-pr.outputs.skip != 'true'
        with:
          sarif_file: semgrep.sarif
