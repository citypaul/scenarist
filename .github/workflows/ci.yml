name: CI

on:
  pull_request:
    branches: ["*"]
  push:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

permissions:
  contents: read

jobs:
  # Job 0: Detect what changed (enables skipping CI for version-only commits)
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code_changed: ${{ steps.filter.outputs.code }}
    steps:
      - name: Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Detect code changes
        id: filter
        env:
          HEAD_REF: ${{ github.head_ref }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          # Version PRs from changesets use branch "changeset-release/main"
          # These only contain version bumps and CHANGELOG updates - skip full CI

          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            if [[ "$HEAD_REF" == "changeset-release/main" ]]; then
              echo "Version PR detected (branch: changeset-release/main)"
              echo "code=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # For push events to main, check if this is a Version PR merge
          # Version PR merges have commit message starting with "chore: release packages"
          if [[ "$EVENT_NAME" == "push" ]]; then
            COMMIT_MSG=$(git log -1 --pretty=%s)
            if [[ "$COMMIT_MSG" == "chore: release packages"* ]]; then
              echo "Version PR merge detected (commit: $COMMIT_MSG)"
              echo "code=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          echo "Regular PR/push detected - running full CI"
          echo "code=true" >> $GITHUB_OUTPUT

  # Job 1: Security Audit (runs early to fail fast on vulnerabilities)
  # Skipped for version-only commits (no new dependencies)
  security-audit:
    name: Security Audit
    needs: detect-changes
    if: needs.detect-changes.outputs.code_changed == 'true'
    timeout-minutes: 5
    runs-on: ubuntu-latest

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5c7944e73c4c2a096b17a9cb74d65b6c2bbafbde # v2.9.1
        with:
          egress-policy: audit

      - name: Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup pnpm
        uses: pnpm/action-setup@9fd676a19091d4595eefd76e4bd31c97133911f1 # v4.2.0
        with:
          version: 9.0.0

      - name: Setup Node.js environment
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        # Use critical level to avoid failing on transitive dependency vulnerabilities
        # High-severity issues in lodash.set (@usebruno/cli) and astro (docs) are tracked via Dependabot
        run: pnpm audit --audit-level critical

      - name: Check licenses
        run: pnpm license:check

  # Job 2: Setup and Build (shared by all other jobs)
  # Skipped for version-only commits (no code to build)
  setup-and-build:
    name: Setup and Build
    needs: detect-changes
    if: needs.detect-changes.outputs.code_changed == 'true'
    timeout-minutes: 10
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 2

      - name: Setup pnpm
        uses: pnpm/action-setup@9fd676a19091d4595eefd76e4bd31c97133911f1 # v4.2.0
        with:
          version: 9.0.0

      - name: Setup Node.js environment
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Get installed Playwright versions
        id: playwright-version
        run: |
          # Get versions from both docs (mermaid) and example apps (E2E tests)
          DOCS_VERSION=$(pnpm --filter=@scenarist/docs list playwright --depth=0 | grep playwright | awk '{print $2}')
          EXAMPLE_VERSION=$(pnpm --filter=@scenarist/nextjs-pages-router-example list @playwright/test --depth=0 | grep @playwright/test | awk '{print $2}')
          echo "DOCS_VERSION=$DOCS_VERSION" >> $GITHUB_OUTPUT
          echo "EXAMPLE_VERSION=$EXAMPLE_VERSION" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          # Composite key ensures cache invalidates if either version changes
          key: ${{ runner.os }}-playwright-docs-${{ steps.playwright-version.outputs.DOCS_VERSION }}-example-${{ steps.playwright-version.outputs.EXAMPLE_VERSION }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          # Install for docs (mermaid rendering) and app examples (E2E tests)
          pnpm --filter=@scenarist/docs exec playwright install --with-deps chromium
          pnpm --filter=@scenarist/nextjs-pages-router-example exec playwright install chromium

      - name: Restore Turborepo cache
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Build
        run: pnpm build

      - name: Cache build artifacts
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            .turbo
            node_modules
            packages/*/dist
            packages/*/node_modules
            internal/*/dist
            internal/*/node_modules
            apps/*/node_modules
            apps/*/.next
            apps/docs/dist
            ~/.cache/ms-playwright
            pnpm-lock.yaml
          key: build-${{ github.sha }}

  # Job 2: Validation (typecheck + lint in parallel)
  validation:
    name: Validation
    needs: setup-and-build
    timeout-minutes: 5
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        check: [typecheck, lint]

    steps:
      - name: Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Restore workspace
        uses: ./.github/actions/restore-workspace

      - name: Run ${{ matrix.check }}
        run: pnpm ${{ matrix.check }}

      - name: Save Turbo cache
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}-validation-${{ matrix.check }}

  # Job 3: Library Tests (packages + internal)
  library-tests:
    name: Library Tests
    needs: setup-and-build
    timeout-minutes: 5
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Restore workspace
        uses: ./.github/actions/restore-workspace

      - name: Run library tests
        run: pnpm turbo test --filter=./packages/* --filter=./internal/*

      - name: Test with coverage (enforces 100% threshold)
        run: pnpm turbo test --filter=@scenarist/core --filter=@scenarist/express-adapter -- --coverage

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v5.0.0
        with:
          name: coverage-reports
          path: "**/coverage/**"
          if-no-files-found: ignore

      - name: Save Turbo cache
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}-library-tests

  # Job 4: Mocked Tests (apps with MSW - proves Scenarist features)
  mocked-tests:
    name: Mocked Tests
    needs: setup-and-build
    timeout-minutes: 10
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Restore workspace
        uses: ./.github/actions/restore-workspace

      - name: Run mocked tests (Playwright + MSW)
        run: pnpm turbo test --filter=./apps/*

      - name: Save Turbo cache
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}-mocked-tests

  # Job 5: Bruno Tests (API contracts + comparison baseline)
  bruno-tests:
    name: Bruno & Baseline Tests
    needs: setup-and-build
    timeout-minutes: 10
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Restore workspace
        uses: ./.github/actions/restore-workspace

      - name: Bruno API Tests
        run: pnpm test:bruno:ci

      - name: Comparison E2E Tests (without Scenarist)
        run: pnpm turbo test:e2e:comparison --filter=@scenarist/nextjs-pages-router-example
        env:
          SKIP_MSW: "true"

  # Job 6: Production Build Tests (verifies tree-shaking & production setup)
  production-build-tests:
    name: Production Build Tests (${{ matrix.name }})
    needs: setup-and-build
    timeout-minutes: 10
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Express
            filter: "@scenarist/express-example"
          - name: App Router
            filter: "@scenarist/nextjs-app-router-example"
          - name: Pages Router
            filter: "@scenarist/nextjs-pages-router-example"

    steps:
      - name: Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Restore workspace
        uses: ./.github/actions/restore-workspace

      - name: Run production build tests
        run: pnpm --filter=${{ matrix.filter }} test:production

  # Job 7: Production Build Tests (Docs - verifies landing page and theme switching)
  docs-production-tests:
    name: Production Build Tests (Docs)
    needs: setup-and-build
    timeout-minutes: 10
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Restore workspace
        uses: ./.github/actions/restore-workspace

      - name: Run docs E2E tests
        run: pnpm --filter=@scenarist/docs test

  # Job 8: Docs Accessibility Tests (Lighthouse and axe-core audits)
  docs-accessibility-tests:
    name: Docs Accessibility Tests
    needs: setup-and-build
    timeout-minutes: 10
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Restore workspace
        uses: ./.github/actions/restore-workspace

      - name: Run accessibility tests (axe-core)
        run: pnpm --filter=@scenarist/docs test:a11y

      - name: Upload Lighthouse reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v5.0.0
        with:
          name: lighthouse-reports
          path: apps/docs/lighthouse-reports/
          if-no-files-found: ignore

  # Job 9: Custom Server Tests (verifies Scenarist works with Express + Next.js custom servers)
  custom-server-tests:
    name: Custom Server Tests (${{ matrix.name }})
    needs: setup-and-build
    timeout-minutes: 10
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: App Router
            filter: "@scenarist/nextjs-app-router-example"
          - name: Pages Router
            filter: "@scenarist/nextjs-pages-router-example"

    steps:
      - name: Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Restore workspace
        uses: ./.github/actions/restore-workspace

      - name: Run custom server tests
        run: pnpm --filter=${{ matrix.filter }} test:custom

  # Job 10: Release Gate (blocks merging until all tests pass)
  # This job serves as a "success signal" for branch protection rules.
  # - For code change PRs: Waits for ALL test jobs and fails if any fail
  # - For Version PRs: Passes immediately (test jobs are skipped)
  release-gate:
    name: Release Gate
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - security-audit
      - validation
      - library-tests
      - mocked-tests
      - bruno-tests
      - production-build-tests
      - docs-production-tests
      - docs-accessibility-tests
      - custom-server-tests
    if: always()
    steps:
      - name: Check CI status
        run: |
          echo "=== Release Gate Status Check ==="
          echo "Code changed: ${{ needs.detect-changes.outputs.code_changed }}"
          echo ""

          # For Version PRs (no code changes), all test jobs are skipped - that's fine
          if [[ "${{ needs.detect-changes.outputs.code_changed }}" == "false" ]]; then
            echo "✅ Fast-path CI - version/changelog only changes detected"
            echo "   Test jobs were skipped (expected behavior)"
            exit 0
          fi

          echo "Full CI run - checking all test job results..."
          echo ""

          # For code change PRs, verify all test jobs passed
          # Jobs that were skipped due to code_changed=false are fine
          # Jobs that failed or were cancelled should block the release

          FAILED=false

          check_job() {
            local job_name=$1
            local job_result=$2
            if [[ "$job_result" == "failure" || "$job_result" == "cancelled" ]]; then
              echo "❌ $job_name: $job_result"
              FAILED=true
            else
              echo "✅ $job_name: $job_result"
            fi
          }

          check_job "security-audit" "${{ needs.security-audit.result }}"
          check_job "validation" "${{ needs.validation.result }}"
          check_job "library-tests" "${{ needs.library-tests.result }}"
          check_job "mocked-tests" "${{ needs.mocked-tests.result }}"
          check_job "bruno-tests" "${{ needs.bruno-tests.result }}"
          check_job "production-build-tests" "${{ needs.production-build-tests.result }}"
          check_job "docs-production-tests" "${{ needs.docs-production-tests.result }}"
          check_job "docs-accessibility-tests" "${{ needs.docs-accessibility-tests.result }}"
          check_job "custom-server-tests" "${{ needs.custom-server-tests.result }}"

          echo ""

          if [[ "$FAILED" == "true" ]]; then
            echo "❌ Release gate FAILED - one or more CI jobs failed or were cancelled"
            echo "   Fix the failing jobs before merging"
            exit 1
          fi

          echo "✅ Release gate PASSED - all CI jobs succeeded"
