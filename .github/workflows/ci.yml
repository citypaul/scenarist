name: CI

on:
  pull_request:
    branches: ["*"]
  push:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  # Job 1: Setup and Build (shared by all other jobs)
  setup-and-build:
    name: Setup and Build
    timeout-minutes: 10
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Get installed Playwright versions
        id: playwright-version
        run: |
          # Get versions from both docs (mermaid) and example apps (E2E tests)
          DOCS_VERSION=$(pnpm --filter=@scenarist/docs list playwright --depth=0 | grep playwright | awk '{print $2}')
          EXAMPLE_VERSION=$(pnpm --filter=@scenarist/nextjs-pages-router-example list @playwright/test --depth=0 | grep @playwright/test | awk '{print $2}')
          echo "DOCS_VERSION=$DOCS_VERSION" >> $GITHUB_OUTPUT
          echo "EXAMPLE_VERSION=$EXAMPLE_VERSION" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          # Composite key ensures cache invalidates if either version changes
          key: ${{ runner.os }}-playwright-docs-${{ steps.playwright-version.outputs.DOCS_VERSION }}-example-${{ steps.playwright-version.outputs.EXAMPLE_VERSION }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          # Install for docs (mermaid rendering) and app examples (E2E tests)
          pnpm --filter=@scenarist/docs exec playwright install --with-deps chromium
          pnpm --filter=@scenarist/nextjs-pages-router-example exec playwright install chromium

      - name: Restore Turborepo cache
        uses: actions/cache/restore@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Build
        run: pnpm build

      - name: Cache build artifacts
        uses: actions/cache/save@v4
        with:
          path: |
            .turbo
            node_modules
            packages/*/dist
            packages/*/node_modules
            apps/*/node_modules
            apps/*/.next
            apps/docs/dist
            ~/.cache/ms-playwright
            pnpm-lock.yaml
          key: build-${{ github.sha }}

  # Job 2: Validation (typecheck + lint in parallel)
  validation:
    name: Validation
    needs: setup-and-build
    timeout-minutes: 5
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        check: [typecheck, lint]

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"

      - name: Restore build artifacts
        uses: actions/cache/restore@v4
        with:
          path: |
            .turbo
            node_modules
            packages/*/dist
            packages/*/node_modules
            apps/*/node_modules
            apps/*/.next
            apps/docs/dist
            ~/.cache/ms-playwright
            pnpm-lock.yaml
          key: build-${{ github.sha }}
          fail-on-cache-miss: true

      - name: Run ${{ matrix.check }}
        run: pnpm ${{ matrix.check }}

      - name: Save Turbo cache
        uses: actions/cache/save@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}-validation-${{ matrix.check }}

  # Job 3: Library Tests (packages only)
  library-tests:
    name: Library Tests
    needs: setup-and-build
    timeout-minutes: 5
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"

      - name: Restore build artifacts
        uses: actions/cache/restore@v4
        with:
          path: |
            .turbo
            node_modules
            packages/*/dist
            packages/*/node_modules
            apps/*/node_modules
            apps/*/.next
            apps/docs/dist
            ~/.cache/ms-playwright
            pnpm-lock.yaml
          key: build-${{ github.sha }}
          fail-on-cache-miss: true

      - name: Run library tests
        run: pnpm turbo test --filter=./packages/*

      - name: Test with coverage (enforces 100% threshold)
        run: pnpm turbo test --filter=@scenarist/core -- --coverage

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: "**/coverage/**"
          if-no-files-found: ignore

      - name: Save Turbo cache
        uses: actions/cache/save@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}-library-tests

  # Job 4: Mocked Tests (apps with MSW - proves Scenarist features)
  mocked-tests:
    name: Mocked Tests
    needs: setup-and-build
    timeout-minutes: 10
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"

      - name: Restore build artifacts
        uses: actions/cache/restore@v4
        with:
          path: |
            .turbo
            node_modules
            packages/*/dist
            packages/*/node_modules
            apps/*/node_modules
            apps/*/.next
            apps/docs/dist
            ~/.cache/ms-playwright
            pnpm-lock.yaml
          key: build-${{ github.sha }}
          fail-on-cache-miss: true

      - name: Run mocked tests (Playwright + MSW)
        run: pnpm turbo test --filter=./apps/*

      - name: Save Turbo cache
        uses: actions/cache/save@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}-mocked-tests

  # Job 5: Bruno Tests (API contracts + comparison baseline)
  bruno-tests:
    name: Bruno & Baseline Tests
    needs: setup-and-build
    timeout-minutes: 10
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"

      - name: Restore build artifacts
        uses: actions/cache/restore@v4
        with:
          path: |
            .turbo
            node_modules
            packages/*/dist
            packages/*/node_modules
            apps/*/node_modules
            apps/*/.next
            apps/docs/dist
            ~/.cache/ms-playwright
            pnpm-lock.yaml
          key: build-${{ github.sha }}
          fail-on-cache-miss: true

      - name: Bruno API Tests
        run: pnpm test:bruno:ci

      - name: Comparison E2E Tests (without Scenarist)
        run: pnpm turbo test:e2e:comparison --filter=@scenarist/nextjs-pages-router-example
        env:
          SKIP_MSW: "true"

  # Job 6: Production Build Tests (verifies tree-shaking & production setup)
  production-build-tests:
    name: Production Build Tests (${{ matrix.name }})
    needs: setup-and-build
    timeout-minutes: 10
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Express
            filter: "@scenarist/express-example"
          - name: App Router
            filter: "@scenarist/nextjs-app-router-example"
          - name: Pages Router
            filter: "@scenarist/nextjs-pages-router-example"

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"

      - name: Restore build artifacts
        uses: actions/cache/restore@v4
        with:
          path: |
            .turbo
            node_modules
            packages/*/dist
            packages/*/node_modules
            apps/*/node_modules
            apps/*/.next
            apps/docs/dist
            ~/.cache/ms-playwright
            pnpm-lock.yaml
          key: build-${{ github.sha }}
          fail-on-cache-miss: true

      - name: Run production build tests
        run: pnpm --filter=${{ matrix.filter }} test:production

  # Job 7: Production Build Tests (Docs - verifies landing page and theme switching)
  docs-production-tests:
    name: Production Build Tests (Docs)
    needs: setup-and-build
    timeout-minutes: 10
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"

      - name: Restore build artifacts
        uses: actions/cache/restore@v4
        with:
          path: |
            .turbo
            node_modules
            packages/*/dist
            packages/*/node_modules
            apps/*/node_modules
            apps/*/.next
            apps/docs/dist
            ~/.cache/ms-playwright
            pnpm-lock.yaml
          key: build-${{ github.sha }}
          fail-on-cache-miss: true

      - name: Run docs E2E tests
        run: pnpm --filter=@scenarist/docs test
