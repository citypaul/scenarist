{
  "permissions": {
    "allow": [
      "Bash(git restore:*)",
      "Bash(pnpm test:*)",
      "Bash(pnpm build:*)",
      "Bash(pnpm exec vitest:*)",
      "Bash(git rm:*)",
      "Bash(gh api:*)",
      "Bash(pnpm test:coverage:*)",
      "Bash(git checkout:*)",
      "Bash(git add:*)",
      "Bash(git commit -m \"$(cat <<''EOF''\nfeat(core): implement template injection for Phase 3\n\nAdd template replacement engine for stateful mock responses:\n\n**Template Replacement Engine:**\n- Created `template-replacement.ts` domain utility\n- Supports `{{state.key}}` pattern detection and replacement\n- Nested path templates: `{{state.user.profile.name}}`\n- Array length templates: `{{state.items.length}}`\n- Missing state keys remain as templates (graceful degradation)\n- Recursive application to objects and arrays\n\n**Integration with ResponseSelector:**\n- Apply templates to response bodies after state capture\n- Templates injected from current state per test ID\n- Works with single responses and sequences\n- Backward compatible (no templates if no state manager)\n\n**Tests:**\n- 11 template replacement unit tests (100% coverage)\n- 7 integration tests in response-selector.test.ts\n- Tests cover: basic injection, nested paths, array length,\n  missing keys, capture+inject, sequences with templates\n\n**Test Results:**\n- 134 tests passing (up from 116)\n- 100% test coverage maintained\n- All edge cases covered (null traversal, non-object traversal)\n\nRelated to #32\n\nðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>\nEOF\n)\")",
      "Bash(git commit -m \"$(cat <<''EOF''\nfeat(core): add state reset on scenario switch for Phase 3\n\nImplement automatic state cleanup when switching scenarios to ensure\neach scenario starts with a clean slate.\n\n**ScenarioManager Updates:**\n- Accept optional `stateManager` parameter via dependency injection\n- Call `stateManager.reset(testId)` after successful scenario switch\n- Maintains backward compatibility (no-op when stateManager not provided)\n- Follows hexagonal architecture (port injected, not created internally)\n\n**State Reset Behavior:**\n- State cleared only on successful scenario switch\n- Failed switches (e.g., scenario not found) do NOT clear state\n- State isolated per test ID (switching test-1 doesn''t affect test-2)\n- Clean slate for each scenario prevents cross-contamination\n\n**Tests:**\n- 4 new tests in scenario-manager.test.ts\n- Test state reset on successful switch\n- Test state NOT reset on failed switch\n- Test backward compatibility (no state manager)\n- Test per-test-ID isolation\n\n**Test Results:**\n- 138 tests passing (up from 134, +4 tests)\n- 100% test coverage maintained\n- All edge cases covered\n\n**Implementation Notes:**\n- State reset happens AFTER scenario is set in store\n- Only resets if stateManager is provided (optional dependency)\n- Enables stateful scenarios to work correctly across switches\n\nRelated to Phase 3: Stateful Mocks (PR #33)\n\nðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>\nEOF\n)\")",
      "Bash(gh pr list:*)",
      "Bash(xargs:*)",
      "Bash(git commit:*)",
      "Bash(git push:*)",
      "Bash(gh pr create:*)",
      "Bash(gh pr view:*)",
      "Bash(gh pr edit:*)",
      "Bash(pnpm install:*)",
      "Bash(pnpm typecheck:*)",
      "Bash(pnpm --filter=@scenarist/nextjs-adapter typecheck:*)",
      "Bash(pnpm --filter=@scenarist/nextjs-adapter clean:*)",
      "Bash(pnpm --filter=@scenarist/nextjs-adapter test)",
      "Bash(pnpm --filter=@scenarist/nextjs-adapter lint:*)",
      "Bash(pnpm --filter=@scenarist/nextjs-adapter build)",
      "Bash(find:*)",
      "Bash(npx tsc:*)",
      "Bash(cat:*)",
      "Bash(pnpm add:*)",
      "Bash(pnpm --filter=@scenarist/nextjs-adapter exec vitest run:*)",
      "Bash(pnpm --filter=@scenarist/express-adapter exec vitest run --coverage)",
      "Bash(pnpm --filter=@scenarist/express-adapter test)",
      "Bash(gh pr comment 40 --body \"$(cat <<''EOF''\n## Final Improvements Complete âœ…\n\nBased on agent feedback and code analysis, I''ve completed comprehensive improvements to the Next.js adapter:\n\n### ðŸ“š Documentation Enhancements\n\n**docs-guardian agent feedback:**\n- âœ… Added user reassurance to coverage exception section\n- âœ… Removed duplicate \"Pages Router vs App Router\" section\n- âœ… Maintained 9.5/10 documentation quality\n\n**learn agent recommendations:**\n- âœ… Added \"Coverage Verification - CRITICAL\" section to CLAUDE.md\n- âœ… Documented PR coverage verification process\n- âœ… Documented exception approval process\n\n### ðŸ”§ Code Quality Improvements (refactor-scan agent)\n\nCompleted **3 high-value refactorings** that eliminated ~280 lines of semantic duplication:\n\n#### 1. Extract createScenarist Shared Logic (083d077)\n- Created `src/common/create-scenarist-base.ts`\n- Eliminated ~150 lines of duplication\n- Pages Router: 125 â†’ 88 lines\n- App Router: 125 â†’ 86 lines\n- **Impact**: Function coverage improved 86.36% â†’ 93%\n\n#### 2. Extract Endpoint Business Logic (c6a5e57)\n- Created `src/common/endpoint-handlers.ts` with pure functions\n- Eliminated ~80 lines of duplication\n- Pages endpoints: 117 â†’ 76 lines\n- App endpoints: 136 â†’ 95 lines\n- **Impact**: Function coverage improved to 93.2%, business logic now independently testable\n\n#### 3. Extract Test Utilities (fef2c0c)\n- Created `tests/common/test-setup.ts`\n- Eliminated ~50 lines of duplication\n- Pages test setup: 38 â†’ 7 lines\n- App test setup: 37 â†’ 6 lines\n- **Impact**: Clearer test intent, consistent test data\n\n### ðŸ“Š Final Metrics\n\n**Test Coverage:**\n- Lines: 100% âœ…\n- Statements: 100% âœ…\n- Branches: 100% âœ…\n- Functions: 93.2% âœ… (improved from 86%, explicit exception documented)\n\n**Tests:** 66 passing âœ…\n\n**Code Quality:**\n- Eliminated ~280 lines of semantic duplication\n- Created 3 reusable common modules\n- Improved maintainability and testability\n\n### ðŸŽ¯ Architecture Benefits\n\n**Reusable Modules Created:**\n1. `src/common/create-scenarist-base.ts` - Shared setup logic for both routers\n2. `src/common/endpoint-handlers.ts` - Framework-agnostic business logic\n3. `tests/common/test-setup.ts` - Consistent test data and factories\n\n**Future Impact:**\n- New adapters can reuse endpoint business logic\n- Test utilities ensure consistency across implementations\n- Single source of truth for setup and business rules\n\n---\n\n**Total Changes:** 12 files changed, 580 insertions(+), 332 deletions(-)\n\nReady for final review! ðŸš€\nEOF\n)\")",
      "Bash(gh pr:*)",
      "Bash(gh run view:*)",
      "Bash(pnpm lint:*)",
      "Bash(pnpm --filter=@scenarist/nextjs-pages-example lint:*)",
      "Bash(pnpm --filter=@scenarist/nextjs-pages-example build)",
      "Bash(pnpm --filter=@scenarist/nextjs-pages-example test:api:*)",
      "Bash(pnpm --filter=@scenarist/nextjs-pages-example test)",
      "Bash(pnpm exec playwright test:*)",
      "Bash(gh run list:*)",
      "Bash(pnpm view:*)",
      "Bash(gh run watch:*)",
      "Bash(pnpm test:e2e:*)",
      "Bash(node -e:*)",
      "Bash(node -p:*)",
      "Bash(pnpm dev)",
      "Bash(curl:*)",
      "Bash(pnpm fake-api:*)",
      "Bash(git reset:*)",
      "Bash(pkill:*)",
      "Bash(lsof:*)",
      "Bash(pnpm turbo build:*)",
      "Bash(pnpm --filter=@scenarist/playwright-helpers build:*)",
      "Bash(pnpm --filter=@scenarist/playwright-helpers test:*)",
      "Bash(pnpm --filter=@scenarist/nextjs-pages-example exec playwright test:*)",
      "Bash(pnpm --filter=@scenarist/express-example typecheck:*)",
      "Bash(pnpm --filter=@scenarist/core test:*)",
      "Bash(git log:*)",
      "Bash(git grep:*)",
      "Bash(PORT=3002 pnpm dev:*)",
      "WebSearch"
    ],
    "deny": [],
    "ask": []
  }
}
